<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Видео с кнопкой разместить</title>
    <!-- Метатеги, важные для работы видео на iOS -->
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin:0; 
            overflow:hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        #fileInput {
            position:fixed; 
            top:15px; 
            left:50%; 
            transform:translateX(-50%); 
            z-index:10;
            background: rgba(255,255,255,0.95);
            color:#2c3e50;
            padding:15px 30px; /* Увеличено */
            border-radius:50px;
            border:2px solid #3498db;
            font-size:16px; /* Увеличено */
            font-weight:600;
            cursor:pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
        }
        
        #fileInput:hover {
            background: white;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
            transform: translateX(-50%) scale(1.05);
        }
        
        #placeBtn {
            position:fixed; 
            bottom:25px; /* Немного выше */
            left:50%;
            transform:translateX(-50%); 
            z-index:10;
            background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            color:white;
            padding:18px 50px; /* Значительно увеличено */
            border-radius:50px;
            font-size:18px; /* Увеличено */
            font-weight:600;
            cursor:pointer;
            border:none;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        #placeBtn:hover {
            transform: translateX(-50%) scale(1.08);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.6);
        }
        
        /* Завершённый стиль для таймера */
        #videoTime {
            position: fixed; 
            top: 15px; 
            right: 15px;
            color: white; 
            background: rgba(0,0,0,0.7);
            padding: 10px 20px; /* Увеличено */
            border-radius: 25px;
            font-size: 16px; /* Увеличено */
            font-weight: 600;
            z-index: 10;
            font-family: monospace; /* Для цифр */
        }
        
        /* Новый элемент для контроля видео (воспроизведение/пауза) */
        #videoControlBtn {
            position: fixed; 
            bottom: 25px; 
            right: 25px;
            z-index: 10;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        #videoControlBtn:hover {
            background: rgba(231, 76, 60, 1);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Кнопка для выбора видеофайла -->
    <input type="file" id="fileInput" accept="video/*">
    <!-- Кнопка для размещения видео в AR -->
    <button id="placeBtn">Разместить видео</button>
    <!-- Кнопка для управления воспроизведением -->
    <button id="videoControlBtn">⏸</button>
    <!-- Дисплей для отображения текущего времени видео -->
    <div id="videoTime">00:00 / 00:00</div>

    <!-- AR-сцена -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <!-- Маркер, на котором будет размещено видео -->
        <a-marker preset="hiro" id="video-marker">
            <!-- 
                Видеоэлемент A-Frame с исправленными атрибутами:
                - shader: standard (вместо flat) корректно отображает текстуру с двух сторон.
                - side: double (вместо front) предотвращает "исчезновение" при повороте.
                - width и height заданы в метрах с сохранением соотношения сторон (например, 16:9).
                - position поднимает видео над маркером для лучшей видимости.
            -->
            <a-video 
                id="ar-video" 
                src="" 
                width="1.6" 
                height="0.9" 
                position="0 0.5 0"
                shader="standard" 
                side="double"
                visible="false">
            </a-video>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Получение ссылок на DOM-элементы
        const fileInput = document.getElementById('fileInput');
        const placeBtn = document.getElementById('placeBtn');
        const videoControlBtn = document.getElementById('videoControlBtn');
        const videoTimeDisplay = document.getElementById('videoTime');
        const arVideoEl = document.getElementById('ar-video');
        
        let currentVideo = null; // Ссылка на объект HTML5 Video
        let isVideoPlaced = false; // Флаг, размещено ли видео в AR
        let videoDuration = 0; // Длительность текущего видео

        // 1. Обработка выбора файла
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('video/')) {
                alert('Пожалуйста, выберите видеофайл.');
                return;
            }
            
            // Освобождение ресурсов предыдущего видео
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.src = '';
            }
            
            // Создание нового объекта Video и URL для него
            const videoURL = URL.createObjectURL(file);
            currentVideo = document.createElement('video');
            currentVideo.src = videoURL;
            currentVideo.loop = true; // Зацикливание видео
            currentVideo.crossOrigin = 'anonymous'; // Для работы с WebGL текстурой
            
            // Установка атрибутов для корректной работы на iOS
            currentVideo.setAttribute('playsinline', '');
            currentVideo.setAttribute('webkit-playsinline', '');
            
            // Обработка загрузки метаданных видео (длительность)
            currentVideo.addEventListener('loadedmetadata', function() {
                videoDuration = currentVideo.duration;
                updateTimeDisplay(0, videoDuration);
                console.log('Видео загружено. Длительность:', videoDuration);
            });
            
            // Обновление таймера во время воспроизведения
            currentVideo.addEventListener('timeupdate', function() {
                if (videoDuration > 0) {
                    updateTimeDisplay(currentVideo.currentTime, videoDuration);
                }
            });
            
            // Связывание HTML5 Video с 3D-элементом A-Frame
            arVideoEl.setAttribute('src', currentVideo);
            isVideoPlaced = false;
            arVideoEl.setAttribute('visible', 'false');
            videoControlBtn.textContent = '⏸';
            alert('Видео загружено. Наведите камеру на маркер Hiro и нажмите "Разместить видео".');
        });

        // 2. Обработка нажатия кнопки "Разместить видео"
        placeBtn.addEventListener('click', function() {
            if (!currentVideo) {
                alert('Сначала выберите видеофайл.');
                return;
            }
            // Делаем видео видимым в AR-сцене
            arVideoEl.setAttribute('visible', 'true');
            isVideoPlaced = true;
            console.log('Видео размещено в AR.');
        });

        // 3. Обработка нажатия кнопки управления воспроизведением
        videoControlBtn.addEventListener('click', function() {
            if (!currentVideo) return;
            
            if (currentVideo.paused) {
                // Если видео на паузе - возобновить
                const playPromise = currentVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Автовоспроизведение предотвращено:", error);
                        // На iOS требуется пользовательское взаимодействие
                        alert('Для воспроизведения нажмите на видео в AR-сцене или на эту кнопку еще раз.');
                    });
                }
                videoControlBtn.textContent = '⏸';
            } else {
                // Если видео воспроизводится - поставить на паузу
                currentVideo.pause();
                videoControlBtn.textContent = '▶';
            }
        });

        // 4. Функция обновления отображения таймера
        function updateTimeDisplay(currentTime, totalTime) {
            const formatTime = (time) => {
                const mins = Math.floor(time / 60);
                const secs = Math.floor(time % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            videoTimeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
        }

        // 5. Обработка клика по самому видео в AR-сцене для запуска
        arVideoEl.addEventListener('click', function(evt) {
            if (!currentVideo) return;
            // Этот клик считается пользовательским взаимодействием, необходимым для iOS
            if (currentVideo.paused) {
                currentVideo.play();
                videoControlBtn.textContent = '⏸';
            } else {
                currentVideo.pause();
                videoControlBtn.textContent = '▶';
            }
            evt.stopPropagation(); // Предотвращение всплытия события
        });

        // Инициализация: скрываем видео при запуске
        arVideoEl.setAttribute('visible', 'false');
    </script>
</body>
</html>
