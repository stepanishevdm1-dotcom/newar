<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Fake AR Fixed Video</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body, html { margin:0; padding:0; overflow:hidden; background:black; }
video#cam { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
video#videoLayer {
  position:absolute;
  width:200px; height:auto;
  display:none;
  transform: translate(-50%,-50%) scale(1) rotate(0deg);
  touch-action: none;
  z-index:10;
}
#ui { position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
     z-index:20; background: rgba(0,0,0,0.6); padding:10px; border-radius:10px;
     color:white; }
input, button { font-size:16px; margin:5px; }
</style>
</head>
<body>

<div id="ui">
  <input type="file" id="videoInput" accept="video/*">
  <button id="reset">Сбросить позицию</button>
</div>

<video id="cam" autoplay muted playsinline></video>
<video id="videoLayer" loop muted playsinline webkit-playsinline></video>

<script>
const cam = document.getElementById('cam');
const videoLayer = document.getElementById('videoLayer');
const input = document.getElementById('videoInput');
const resetBtn = document.getElementById('reset');

let videoLoaded = false;

// Камера
navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false})
.then(stream => { cam.srcObject = stream; })
.catch(e => alert('Не удалось включить камеру: ' + e));

// Загрузка видео
input.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  videoLayer.src = url;
  videoLayer.muted = false;
  videoLayer.play().catch(()=>{});
  videoLoaded = true;
});

// Координаты видео
let posX = 0, posY = 0, scale = 1, rotation = 0;

// Ставим видео по тапу
cam.addEventListener('click', e=>{
  if(!videoLoaded) { alert("Сначала выберите видео"); return; }
  posX = e.clientX;
  posY = e.clientY;
  videoLayer.style.left = posX+'px';
  videoLayer.style.top = posY+'px';
  videoLayer.style.display = 'block';
  updateTransform();
});

// Перетаскивание/масштаб/поворот
let startX=0, startY=0, startDistance=null, startRotation=null;

videoLayer.addEventListener('touchstart', e=>{
  e.preventDefault();
  if(e.touches.length===1){
    startX = e.touches[0].clientX - posX;
    startY = e.touches[0].clientY - posY;
  } else if(e.touches.length===2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    startDistance = Math.hypot(dx,dy)/scale;
    startRotation = Math.atan2(dy,dx) - rotation*Math.PI/180;
  }
}, {passive:false});

videoLayer.addEventListener('touchmove', e=>{
  e.preventDefault();
  if(e.touches.length===1){
    posX = e.touches[0].clientX - startX;
    posY = e.touches[0].clientY - startY;
  } else if(e.touches.length===2 && startDistance!==null){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    scale = Math.hypot(dx,dy)/startDistance;
    rotation = (Math.atan2(dy,dx) - startRotation) * 180/Math.PI;
  }
  updateTransform();
}, {passive:false});

videoLayer.addEventListener('touchend', e=>{
  if(e.touches.length<2){ startDistance=null; startRotation=null; }
});

function updateTransform(){
  videoLayer.style.transform = `translate(-50%,-50%) scale(${scale}) rotate(${rotation}deg)`;
}

// Кнопка сброса
resetBtn.addEventListener('click', ()=>{
  videoLayer.style.display='none';
  posX=0; posY=0; scale=1; rotation=0;
});
</script>

</body>
</html>
