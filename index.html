<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR –í–∏–¥–µ–æ —Å Gaze</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<style>
body { margin:0; overflow:hidden; }
#gaze-circle { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  width: 25px; height: 25px; border: 2px solid white; border-radius: 50%;
  z-index:100; pointer-events: none;}
#gaze-fill { position: absolute; top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.5); border-radius:50%;
  transform: scaleY(0); transform-origin: bottom; transition: transform 0.05s linear;}
#videoTime { position: fixed; top:10px; right:10px; z-index:100;
  color:white; background: rgba(0,0,0,0.5); padding:3px 6px; border-radius:5px;
  font-family: monospace; font-size:14px;}
#fileInput { position: fixed; top:10px; left:50%; transform:translateX(-50%); z-index:100;
  background: rgba(0,0,0,0.5); color:white; padding:5px 10px; border-radius:5px;}
#showBtnHTML { position: fixed; bottom:60px; left:50%; transform: translateX(-50%);
  padding: 10px 20px; background: rgba(0,0,0,0.5); color:white; border-radius:5px;
  cursor: pointer; z-index:100;}
#sizeSliderContainer { position: fixed; bottom:20px; left:50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px; z-index:100;}
</style>
</head>
<body>
<input type="file" id="fileInput" accept="video/*">
<div id="showBtnHTML">üì∫ Show Video</div>
<div id="sizeSliderContainer">
<label style="color:white;">Video Size:</label>
<input type="range" id="sizeSlider" min="0.2" max="5" step="0.05" value="1">
</div>
<div id="gaze-circle"><div id="gaze-fill"></div></div>
<div id="videoTime">00:00 / 00:00</div>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
const showBtnHTML = document.getElementById('showBtnHTML');
const gazeFill = document.getElementById('gaze-fill');
const sizeSlider = document.getElementById('sizeSlider');
const videoTimeEl = document.getElementById('videoTime');

let videoEl, videoMesh, videoTexture;
let videoWidth = 1, videoHeight = 0.6;
let firstInteraction = true;

// --------------------- –ö–Ω–æ–ø–∫–∏ ---------------------
let btnGroup = new THREE.Group();
scene.object3D.add(btnGroup);

function createButton(text, color){
  const canvas = document.createElement('canvas');
  canvas.width = 256; canvas.height = 128;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = color;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font = '48px Arial';
  ctx.fillStyle = 'black';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, canvas.width/2, canvas.height/2);
  const texture = new THREE.CanvasTexture(canvas);
  const mat = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
  const geom = new THREE.PlaneGeometry(0.4,0.15);
  const mesh = new THREE.Mesh(geom, mat);
  mesh.userData.label = text;
  return mesh;
}

const playBtn = createButton('Play','#00ff00');
const pauseBtn = createButton('Pause','#ffff00');
const plus5Btn = createButton('+5','#00ffff');
const minus5Btn = createButton('-5','#ff00ff');

const spacing = 0.5;
playBtn.position.set(-1.5*spacing, -0.8, 0);
pauseBtn.position.set(-0.5*spacing, -0.8, 0);
minus5Btn.position.set(0.5*spacing, -0.8, 0);
plus5Btn.position.set(1.5*spacing, -0.8, 0);

btnGroup.add(playBtn,pauseBtn,minus5Btn,plus5Btn);
btnGroup.visible = false;

// --------------------- –í–∏–¥–µ–æ ---------------------
fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);

  videoEl = document.createElement('video');
  videoEl.src = url;
  videoEl.loop = true;
  videoEl.muted = false;
  videoEl.playsInline = true;
  videoEl.crossOrigin = 'anonymous';

  videoEl.addEventListener('loadeddata', ()=>{
    videoWidth = videoEl.videoWidth / videoEl.videoHeight;
    videoHeight = 1;

    if(!videoMesh){
      const geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
      videoTexture = new THREE.VideoTexture(videoEl);
      const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
      videoMesh = new THREE.Mesh(geometry, material);
      videoMesh.visible = false;
      scene.object3D.add(videoMesh);
    } else {
      videoMesh.geometry.dispose();
      videoMesh.geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
    }
  });
});

// --------------------- –ü–æ–∫–∞–∑ –≤–∏–¥–µ–æ ---------------------
function showVideo(){
  if(!videoMesh || !videoEl) return;
  const camera = scene.camera;
  const distance = 2;
  const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
  const pos = camera.position.clone().add(dir.multiplyScalar(distance));

  videoMesh.position.copy(pos);
  videoMesh.visible = true;

  btnGroup.position.copy(pos);
  btnGroup.visible = true;

  if(firstInteraction){
    videoEl.muted=false;
    videoEl.play().catch(()=>{});
    firstInteraction=false;
  }
}

// --------------------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ ---------------------
scene.addEventListener('render-target-loaded', ()=>{
  scene.addEventListener('tick', ()=>{
    if(videoMesh && videoMesh.visible){
      videoMesh.lookAt(scene.camera.position);
      btnGroup.lookAt(scene.camera.position);
    }
    if(videoEl){
      function formatTime(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;}
      videoTimeEl.textContent = `${formatTime(videoEl.currentTime)} / ${formatTime(videoEl.duration||0)}`;
    }
  });
});

// --------------------- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ---------------------
sizeSlider.addEventListener('input', ()=>{
  if(videoMesh && btnGroup){
    const scale = parseFloat(sizeSlider.value);
    videoMesh.scale.set(scale,scale,1);
    btnGroup.scale.set(scale,scale,1);
  }
});

// --------------------- Gaze ---------------------
let activeBtn = null;
let gazeStartTime = 0;
const gazeDuration = 3000;

function executeButton(btn){
  if(!videoEl) return;
  switch(btn.userData.label){
    case 'Play': videoEl.play(); break;
    case 'Pause': videoEl.pause(); break;
    case '+5': videoEl.currentTime = Math.min(videoEl.duration, videoEl.currentTime+5); break;
    case '-5': videoEl.currentTime = Math.max(0, videoEl.currentTime-5); break;
  }
}

scene.addEventListener('tick', ()=>{
  if(!btnGroup.visible || !videoEl) return;
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2(0,0); // —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
  raycaster.setFromCamera(mouse, scene.camera);

  const intersects = raycaster.intersectObjects([playBtn,pauseBtn,plus5Btn,minus5Btn]);

  if(intersects.length > 0){
    const btn = intersects[0].object;
    if(activeBtn !== btn){
      activeBtn = btn;
      gazeStartTime = performance.now();
    } else {
      const progress = (performance.now() - gazeStartTime)/gazeDuration;
      gazeFill.style.transform = `scaleY(${Math.min(progress,1)})`;
      if(progress >= 1){
        executeButton(btn);
        gazeFill.style.transform='scaleY(0)';
        activeBtn = null;
      }
    }
  } else {
    activeBtn = null;
    gazeFill.style.transform='scaleY(0)';
  }
});

// --------------------- Show –∫–Ω–æ–ø–∫–∞ ---------------------
showBtnHTML.addEventListener('click', showVideo);
</script>
</body>
</html>
