<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Video Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #videoTime {
            position: fixed;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            z-index: 999;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #fileInput {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }
        
        #fileInput::-webkit-file-upload-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <input id="fileInput" type="file" accept="video/*">
    <div id="videoTime">00:00 / 00:00</div>
    <div id="loading" class="loading">Загрузка видео...</div>
    
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <!-- Камера с курсором -->
        <a-entity camera look-controls="enabled: false">
            <a-cursor 
                fuse="true" 
                fuse-timeout="1000" 
                raycaster="objects: .btn"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                material="color: #ffffff; shader: flat">
            </a-cursor>
        </a-entity>
        
        <!-- Видеоплейер -->
        <a-entity id="videoPlayer" position="0 0 -1.5" visible="false">
            <!-- Видео -->
            <a-video 
                id="videoPlane"
                width="1.6"
                height="0.9"
                scale="-1 1 1"
                material="shader: flat; side: double">
            </a-video>
            
            <!-- Кнопки управления -->
            <a-entity id="buttons" position="0 -0.55 0">
                <!-- Play -->
                <a-entity class="btn" position="-0.6 0 0">
                    <a-plane 
                        color="#00ff00"
                        width="0.35"
                        height="0.15"
                        animation__mouseenter="property: scale; to: 1.1 1.1 1; dur: 200; startEvents: mouseenter"
                        animation__mouseleave="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
                    </a-plane>
                    <a-text 
                        value="▶"
                        align="center"
                        position="0 0 0.01"
                        scale="0.8 0.8 1"
                        color="#000000">
                    </a-text>
                </a-entity>
                
                <!-- Pause -->
                <a-entity class="btn" position="-0.2 0 0">
                    <a-plane 
                        color="#ffff00"
                        width="0.35"
                        height="0.15"
                        animation__mouseenter="property: scale; to: 1.1 1.1 1; dur: 200; startEvents: mouseenter"
                        animation__mouseleave="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
                    </a-plane>
                    <a-text 
                        value="⏸"
                        align="center"
                        position="0 0 0.01"
                        scale="0.8 0.8 1"
                        color="#000000">
                    </a-text>
                </a-entity>
                
                <!-- +5 секунд -->
                <a-entity class="btn" position="0.2 0 0">
                    <a-plane 
                        color="#00ffff"
                        width="0.35"
                        height="0.15"
                        animation__mouseenter="property: scale; to: 1.1 1.1 1; dur: 200; startEvents: mouseenter"
                        animation__mouseleave="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
                    </a-plane>
                    <a-text 
                        value="+5s"
                        align="center"
                        position="0 0 0.01"
                        scale="0.6 0.6 1"
                        color="#000000">
                    </a-text>
                </a-entity>
                
                <!-- -5 секунд -->
                <a-entity class="btn" position="0.6 0 0">
                    <a-plane 
                        color="#ff00ff"
                        width="0.35"
                        height="0.15"
                        animation__mouseenter="property: scale; to: 1.1 1.1 1; dur: 200; startEvents: mouseenter"
                        animation__mouseleave="property: scale; to: 1 1 1; dur: 200; startEvents: mouseleave">
                    </a-plane>
                    <a-text 
                        value="-5s"
                        align="center"
                        position="0 0 0.01"
                        scale="0.6 0.6 1"
                        color="#000000">
                    </a-text>
                </a-entity>
            </a-entity>
            
            <!-- Индикатор загрузки -->
            <a-entity id="loadingIndicator" position="0 0 0.01" visible="false">
                <a-ring color="#ffffff" radius-inner="0.1" radius-outer="0.15">
                    <a-animation attribute="rotation" dur="1000" to="0 0 360" repeat="indefinite"></a-animation>
                </a-ring>
            </a-entity>
        </a-entity>
    </a-scene>
    
    <script>
        let videoEl = null;
        const videoPlayer = document.getElementById('videoPlayer');
        const videoPlane = document.getElementById('videoPlane');
        const buttons = document.getElementById('buttons');
        const timeEl = document.getElementById('videoTime');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Форматирование времени
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };
        
        // Загрузка видео
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Показать индикатор загрузки
            loading.style.display = 'block';
            loadingIndicator.setAttribute('visible', true);
            
            try {
                // Создать элемент видео
                videoEl = document.createElement('video');
                videoEl.src = URL.createObjectURL(file);
                videoEl.loop = true;
                videoEl.playsInline = true;
                videoEl.crossOrigin = 'anonymous';
                videoEl.preload = 'metadata';
                
                // Дождаться загрузки метаданных
                await new Promise((resolve, reject) => {
                    videoEl.onloadedmetadata = resolve;
                    videoEl.onerror = reject;
                    setTimeout(() => reject(new Error('Timeout loading video')), 10000);
                });
                
                // Установить видео в плоскость
                videoPlane.setAttribute('src', `#${videoEl.id}`);
                videoPlane.appendChild(videoEl);
                
                // Показать плеер
                videoPlayer.setAttribute('visible', true);
                
                // Начать воспроизведение
                try {
                    await videoEl.play();
                } catch (err) {
                    console.log('Автовоспроизведение не удалось:', err);
                }
                
            } catch (error) {
                console.error('Ошибка загрузки видео:', error);
                alert('Ошибка загрузки видео: ' + error.message);
            } finally {
                // Скрыть индикатор загрузки
                loading.style.display = 'none';
                loadingIndicator.setAttribute('visible', false);
            }
        };
        
        // Обновление таймера
        setInterval(() => {
            if (!videoEl) return;
            
            const current = videoEl.currentTime;
            const duration = videoEl.duration || 0;
            
            if (!isNaN(duration)) {
                timeEl.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
            }
        }, 200);
        
        // Компоненты для кнопок
        AFRAME.registerComponent('play-btn', {
            init() {
                this.el.addEventListener('fuse', () => {
                    if (videoEl) {
                        videoEl.play();
                        // Анимация нажатия
                        this.el.setAttribute('animation__click', 'property: scale; to: 0.9 0.9 1; dur: 100; easing: easeOutCubic');
                        setTimeout(() => {
                            this.el.removeAttribute('animation__click');
                        }, 100);
                    }
                });
            }
        });
        
        AFRAME.registerComponent('pause-btn', {
            init() {
                this.el.addEventListener('fuse', () => {
                    if (videoEl) {
                        videoEl.pause();
                        // Анимация нажатия
                        this.el.setAttribute('animation__click', 'property: scale; to: 0.9 0.9 1; dur: 100; easing: easeOutCubic');
                        setTimeout(() => {
                            this.el.removeAttribute('animation__click');
                        }, 100);
                    }
                });
            }
        });
        
        AFRAME.registerComponent('plus-btn', {
            init() {
                this.el.addEventListener('fuse', () => {
                    if (videoEl) {
                        videoEl.currentTime = Math.min(videoEl.duration, videoEl.currentTime + 5);
                        // Анимация нажатия
                        this.el.setAttribute('animation__click', 'property: scale; to: 0.9 0.9 1; dur: 100; easing: easeOutCubic');
                        setTimeout(() => {
                            this.el.removeAttribute('animation__click');
                        }, 100);
                    }
                });
            }
        });
        
        AFRAME.registerComponent('minus-btn', {
            init() {
                this.el.addEventListener('fuse', () => {
                    if (videoEl) {
                        videoEl.currentTime = Math.max(0, videoEl.currentTime - 5);
                        // Анимация нажатия
                        this.el.setAttribute('animation__click', 'property: scale; to: 0.9 0.9 1; dur: 100; easing: easeOutCubic');
                        setTimeout(() => {
                            this.el.removeAttribute('animation__click');
                        }, 100);
                    }
                });
            }
        });
        
        // Назначить компоненты кнопкам
        document.querySelectorAll('.btn').forEach((btn, index) => {
            switch(index) {
                case 0:
                    btn.setAttribute('play-btn', '');
                    break;
                case 1:
                    btn.setAttribute('pause-btn', '');
                    break;
                case 2:
                    btn.setAttribute('plus-btn', '');
                    break;
                case 3:
                    btn.setAttribute('minus-btn', '');
                    break;
            }
        });
        
        // Освобождение ресурсов при закрытии
        window.addEventListener('beforeunload', () => {
            if (videoEl && videoEl.src) {
                URL.revokeObjectURL(videoEl.src);
            }
        });
    </script>
</body>
</html>
