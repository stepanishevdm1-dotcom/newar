<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR –í–∏–¥–µ–æ —Å –∫–Ω–æ–ø–∫–æ–π Show</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin:0; overflow:hidden; }
    #fileInput {
      position: fixed; top:10px; left:50%; transform:translateX(-50%); z-index:100;
      background: rgba(0,0,0,0.5); color:white; padding:5px 10px; border-radius:5px;
    }
    #showBtnHTML {
      position: fixed; bottom:20px; left:50%; transform: translateX(-50%);
      padding: 10px 20px; background: rgba(0,0,0,0.5); color:white; border-radius:5px;
      cursor: pointer; z-index:100;
    }
  </style>
</head>
<body>
<input type="file" id="fileInput" accept="video/*">
<div id="showBtnHTML">üì∫ Show Video</div>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
const showBtnHTML = document.getElementById('showBtnHTML');

let videoEl, videoMesh, videoTexture;
let videoWidth = 1, videoHeight = 0.6;
let firstInteraction = true;

// 3D –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –≤–∏–¥–µ–æ
let btnGroup;
let playBtn, pauseBtn, hideBtn;

// --------------------- –í–∏–¥–µ–æ ---------------------
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);

  videoEl = document.createElement('video');
  videoEl.src = url;
  videoEl.loop = true;
  videoEl.muted = false;
  videoEl.playsInline = true;
  videoEl.crossOrigin = 'anonymous';

  videoEl.addEventListener('loadeddata', () => {
    videoWidth = videoEl.videoWidth / videoEl.videoHeight;
    videoHeight = 1;

    if(!videoMesh){
      const geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
      videoTexture = new THREE.VideoTexture(videoEl);
      const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
      videoMesh = new THREE.Mesh(geometry, material);
      videoMesh.visible = false;
      scene.object3D.add(videoMesh);

      // 3D –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –≤–∏–¥–µ–æ
      btnGroup = new THREE.Group();
      const btnGeom = new THREE.PlaneGeometry(0.3,0.1);
      const createBtn = (text,color) => {
        const mat = new THREE.MeshBasicMaterial({color: color, side: THREE.DoubleSide});
        const mesh = new THREE.Mesh(btnGeom, mat);
        mesh.userData.label = text;
        return mesh;
      }

      playBtn = createBtn('‚ñ∂', 0x00ff00);
      pauseBtn = createBtn('‚è∏', 0xffff00);
      hideBtn = createBtn('‚úñ', 0xff0000);

      const spacing = 0.35;
      playBtn.position.set(-spacing, -videoHeight/2 - 0.15, 0);
      pauseBtn.position.set(0, -videoHeight/2 - 0.15, 0);
      hideBtn.position.set(spacing, -videoHeight/2 - 0.15, 0);

      btnGroup.add(playBtn,pauseBtn,hideBtn);
      btnGroup.visible = false;
      scene.object3D.add(btnGroup);
    } else {
      videoMesh.geometry.dispose();
      videoMesh.geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
    }
  });
});

// --------------------- –ü–æ–∫–∞–∑ –≤–∏–¥–µ–æ ---------------------
function showVideo() {
  if(!videoMesh || !videoEl) return;

  const camera = scene.camera;
  const distance = 2; 
  const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
  const pos = camera.position.clone().add(dir.multiplyScalar(distance));

  videoMesh.position.copy(pos);
  videoMesh.visible = true;

  btnGroup.position.copy(pos);
  btnGroup.visible = true;

  if(firstInteraction){
    videoEl.muted = false;
    videoEl.play().catch(()=>{});
    firstInteraction = false;
  }
}

// --------------------- Billboard ---------------------
scene.addEventListener('render-target-loaded', ()=>{
  scene.addEventListener('tick', ()=>{
    if(videoMesh && videoMesh.visible){
      videoMesh.lookAt(scene.camera.position);
      btnGroup.lookAt(scene.camera.position);
    }
  });
});

// --------------------- 3D –∫–Ω–æ–ø–∫–∏ –∫–ª–∏–∫–∏ ---------------------
scene.addEventListener('click', event=>{
  if(!btnGroup.visible) return;

  const mouse = new THREE.Vector2();
  mouse.x = (event.clientX / window.innerWidth)*2-1;
  mouse.y = -(event.clientY / window.innerHeight)*2+1;

  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, scene.camera);
  const intersects = raycaster.intersectObjects([playBtn,pauseBtn,hideBtn]);

  if(intersects.length>0){
    const btn = intersects[0].object;
    switch(btn.userData.label){
      case '‚ñ∂': videoEl.play(); break;
      case '‚è∏': videoEl.pause(); break;
      case '‚úñ': videoMesh.visible=false; btnGroup.visible=false; break;
    }
  }
});

// --------------------- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ---------------------
let startDistance = null;
let startScale = 1;
scene.addEventListener('touchstart', e=>{
  if(e.touches.length==2 && videoMesh){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    startDistance = Math.sqrt(dx*dx+dy*dy);
    startScale = videoMesh.scale.x;
  }
});

scene.addEventListener('touchmove', e=>{
  if(e.touches.length==2 && videoMesh && startDistance){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const newDistance = Math.sqrt(dx*dx+dy*dy);
    const scaleFactor = newDistance/startDistance;

    let newScale = Math.min(Math.max(startScale*scaleFactor,0.2),5);
    videoMesh.scale.set(newScale,newScale,1);
    btnGroup.scale.set(newScale,newScale,1);
  }
});

// --------------------- Gaze –¥–ª—è –∫–Ω–æ–ø–∫–∏ Show ---------------------
let gazeTimer = null;
let gazeDuration = 3000; // 3 —Å–µ–∫—É–Ω–¥—ã
function startGaze(){
  let startTime = performance.now();
  gazeTimer = requestAnimationFrame(function tick(time){
    let progress = (time-startTime)/gazeDuration;
    if(progress>=1){
      showVideo();
    } else {
      gazeTimer = requestAnimationFrame(tick);
    }
  });
}
function stopGaze(){ if(gazeTimer) cancelAnimationFrame(gazeTimer); }

showBtnHTML.addEventListener('mouseenter', startGaze);
showBtnHTML.addEventListener('mouseleave', stopGaze);
showBtnHTML.addEventListener('click', showVideo);

</script>
</body>
</html>
