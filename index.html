<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR –í–∏–¥–µ–æ —Å –∫–Ω–æ–ø–∫–æ–π —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin:0; 
            overflow:hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        #fileInput {
            position:fixed; 
            top:15px; 
            left:50%; 
            transform:translateX(-50%); 
            z-index:10;
            background: rgba(255,255,255,0.95);
            color:#2c3e50;
            padding:12px 25px;
            border-radius:50px;
            border:2px solid #3498db;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
        }
        
        #fileInput:hover {
            background: white;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
            transform: translateX(-50%) scale(1.05);
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ */
        #videoControls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .controlBtn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .controlBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }
        
        .controlBtn#playBtn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .controlBtn#pauseBtn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .controlBtn#stopBtn {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        }
        
        .controlBtn#placeBtn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 16px 30px;
        }
        
        /* –¢–∞–π–º–µ—Ä –≤–∏–¥–µ–æ */
        #videoTime {
            position: fixed; 
            top: 15px; 
            right: 15px;
            color: white; 
            background: rgba(0,0,0,0.8);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: monospace;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loadingIndicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.8);
            padding: 20px 30px;
            border-radius: 10px;
            display: none;
            z-index: 100;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */
        #instructions {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            font-size: 14px;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            #videoControls {
                flex-wrap: wrap;
                justify-content: center;
                width: 90%;
                padding: 12px 15px;
                gap: 10px;
            }
            
            .controlBtn {
                padding: 14px 18px;
                font-size: 16px;
                min-width: 50px;
            }
            
            #videoTime {
                font-size: 14px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept="video/*" />
    
    <div id="instructions">
        üì± 1. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ<br>
        üéØ 2. –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç—å<br>
        üìç 3. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å"
    </div>
    
    <div id="videoTime">00:00 / 00:00</div>
    
    <div id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
    
    <div id="videoControls" style="display:none;">
        <button class="controlBtn" id="playBtn">‚ñ∂Ô∏è</button>
        <button class="controlBtn" id="pauseBtn">‚è∏Ô∏è</button>
        <button class="controlBtn" id="stopBtn">‚èπÔ∏è</button>
        <button class="controlBtn" id="placeBtn">üìç –†–∞–∑–º–µ—Å—Ç–∏—Ç—å</button>
    </div>
    
    <!-- AR-—Å—Ü–µ–Ω–∞ -->
    <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="antialias: true; alpha: true"
        embedded
    >
        <a-assets>
            <video id="videoSource" autoplay loop crossorigin="anonymous" style="display:none;"></video>
        </a-assets>
        
        <!-- –ú–∞—Ä–∫–µ—Ä –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤–∏–¥–µ–æ -->
        <a-marker id="videoMarker" type="pattern" preset="custom" url="data/marker.patt" visible="false">
            <a-video 
                id="arVideo"
                src="#videoSource"
                width="2" 
                height="1.125"
                position="0 0 0"
                rotation="-90 0 0"
                transparent="true"
                visible="false"
                material="shader: flat;"
            ></a-video>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const fileInput = document.getElementById('fileInput');
        const videoTime = document.getElementById('videoTime');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const videoControls = document.getElementById('videoControls');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const placeBtn = document.getElementById('placeBtn');
        const instructions = document.getElementById('instructions');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã A-Frame
        const scene = document.querySelector('a-scene');
        const arVideo = document.getElementById('arVideo');
        const videoSource = document.getElementById('videoSource');
        const videoMarker = document.getElementById('videoMarker');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let isVideoPlaced = false;
        let videoDuration = 0;
        let updateInterval;
        let isVideoPlaying = false;
        let currentVideoRotation = { x: -90, y: 0, z: 0 };
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('video/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª');
                return;
            }
            
            loadingIndicator.style.display = 'block';
            
            const videoURL = URL.createObjectURL(file);
            videoSource.src = videoURL;
            
            videoSource.onloadeddata = function() {
                loadingIndicator.style.display = 'none';
                videoControls.style.display = 'flex';
                instructions.style.display = 'none';
                
                videoDuration = videoSource.duration;
                updateVideoTime();
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
                startTimeUpdate();
                
                // –í–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
                setupVideoControls();
            };
            
            videoSource.onerror = function() {
                loadingIndicator.style.display = 'none';
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
            };
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–∏–¥–µ–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–∞–≥ —Å –ø–∞—É–∑–æ–π)
        function updateVideoTime() {
            if (!videoSource.src) return;
            
            const current = videoSource.currentTime;
            const total = videoDuration;
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            videoTime.textContent = `${formatTime(current)} / ${formatTime(total)}`;
        }
        
        // –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
        function startTimeUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                if (!videoSource.paused && videoSource.readyState >= 2) {
                    updateVideoTime();
                }
            }, 100);
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function setupVideoControls() {
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            playBtn.addEventListener('click', () => {
                if (videoSource.src) {
                    videoSource.play();
                    isVideoPlaying = true;
                    console.log('Video playing');
                }
            });
            
            // –ü–∞—É–∑–∞
            pauseBtn.addEventListener('click', () => {
                if (videoSource.src) {
                    videoSource.pause();
                    isVideoPlaying = false;
                    console.log('Video paused');
                }
            });
            
            // –°—Ç–æ–ø
            stopBtn.addEventListener('click', () => {
                if (videoSource.src) {
                    videoSource.pause();
                    videoSource.currentTime = 0;
                    isVideoPlaying = false;
                    updateVideoTime();
                    console.log('Video stopped');
                }
            });
            
            // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤–∏–¥–µ–æ –≤ AR
            placeBtn.addEventListener('click', () => {
                if (!videoSource.src) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ!');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ –º–∞—Ä–∫–µ—Ä
                arVideo.setAttribute('visible', 'true');
                videoMarker.setAttribute('visible', 'true');
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –æ—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏–µ–º
                arVideo.setAttribute('material', 'shader: flat; side: front;');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ
                arVideo.setAttribute('width', '2');
                arVideo.setAttribute('height', '1.125');
                arVideo.setAttribute('position', '0 0 0');
                arVideo.setAttribute('rotation', currentVideoRotation);
                
                // –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                videoSource.play();
                isVideoPlaying = true;
                isVideoPlaced = true;
                
                console.log('Video placed in AR');
            });
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –≤–∏–¥–µ–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            videoSource.addEventListener('play', () => {
                isVideoPlaying = true;
                console.log('Video play event');
            });
            
            videoSource.addEventListener('pause', () => {
                isVideoPlaying = false;
                console.log('Video pause event');
            });
            
            videoSource.addEventListener('ended', () => {
                isVideoPlaying = false;
                videoSource.currentTime = 0;
                console.log('Video ended');
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤–∏–¥–µ–æ –≤ AR (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –∏—Å–∫–∞–∂–µ–Ω–∏–µ–º)
        scene.addEventListener('loaded', () => {
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –±–∞–≥ —Å –æ—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏–µ–º –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
            arVideo.addEventListener('componentchanged', function(e) {
                if (e.detail.name === 'rotation') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–≤–æ—Ä–æ—Ç
                    currentVideoRotation = arVideo.getAttribute('rotation');
                    
                    // –§–∏–∫—Å–∏—Ä—É–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
                    arVideo.setAttribute('width', '2');
                    arVideo.setAttribute('height', '1.125');
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –Ω–µ –∑–µ—Ä–∫–∞–ª–∏—Ç—Å—è
                    arVideo.setAttribute('material', 'shader: flat; side: front;');
                    
                    console.log('Video rotated:', currentVideoRotation);
                }
                
                if (e.detail.name === 'scale') {
                    // –§–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –≤–∏–¥–µ–æ
                    const scale = arVideo.getAttribute('scale');
                    const fixedHeight = scale.y;
                    const fixedWidth = fixedHeight * (2 / 1.125); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 16:9
                    
                    arVideo.setAttribute('scale', {
                        x: fixedWidth,
                        y: fixedHeight,
                        z: 1
                    });
                    
                    console.log('Video scale fixed:', fixedWidth, fixedHeight);
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ currentTime
            videoSource.addEventListener('timeupdate', updateVideoTime);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Å–∞–Ω–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        let touchStartX = 0;
        let touchStartY = 0;
        
        arVideo.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            e.preventDefault();
        });
        
        arVideo.addEventListener('touchmove', function(e) {
            if (!touchStartX || !touchStartY) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            
            // –í—Ä–∞—â–µ–Ω–∏–µ –≤–∏–¥–µ–æ
            if (Math.abs(deltaX) > 10) {
                const rotation = arVideo.getAttribute('rotation');
                arVideo.setAttribute('rotation', {
                    x: rotation.x,
                    y: rotation.y + deltaX * 0.5,
                    z: rotation.z
                });
                touchStartX = touchX;
            }
            
            e.preventDefault();
        });
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        document.addEventListener('touchmove', function(e) {
            if (e.target === arVideo) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('AR Video App loaded successfully');
        console.log('Known issues fixed:');
        console.log('1. Timer continues after pause/resume');
        console.log('2. Video maintains aspect ratio when moved');
        console.log('3. No mirroring effect on movement');
    </script>
</body>
</html>
