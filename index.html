<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>WebXR AR Video Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: black;
  color: white;
}
#ui {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  background: rgba(0,0,0,0.7);
  padding: 10px;
  border-radius: 10px;
}
button, input {
  font-size: 16px;
  margin: 5px 0;
}
#log {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.8);
  font-size: 14px;
  padding: 5px;
}
</style>
</head>

<body>

<div id="log">Статус: загрузка</div>

<div id="ui">
  <input type="file" id="videoInput" accept="video/*"><br>
  <button id="start">START AR</button>
</div>

<video id="video" loop playsinline webkit-playsinline style="display:none"></video>

<script>
const log = msg => document.getElementById("log").textContent = "Статус: " + msg;

log("проверка WebXR");

if (!navigator.xr) {
  log("WebXR НЕ поддерживается этим браузером");
}

const video = document.getElementById("video");
let videoReady = false;

document.getElementById("videoInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  video.src = URL.createObjectURL(file);
  video.muted = false;
  video.play();

  videoReady = true;
  log("видео загружено");
};

document.getElementById("start").onclick = async () => {
  if (!videoReady) {
    alert("Сначала выбери видео");
    return;
  }

  if (!navigator.xr) {
    alert("WebXR не поддерживается");
    return;
  }

  try {
    log("запрос AR сессии");

    const session = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["local-floor"]
    });

    log("AR сессия запущена");

    const canvas = document.createElement("canvas");
    document.body.appendChild(canvas);

    const gl = canvas.getContext("webgl", { xrCompatible: true });
    session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

    const refSpace = await session.requestReferenceSpace("local-floor");

    session.requestAnimationFrame(function render(t, frame) {
      session.requestAnimationFrame(render);
      gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
      gl.clearColor(0,0,0,0);
      gl.clear(gl.COLOR_BUFFER_BIT);
    });

  } catch (e) {
    console.error(e);
    log("ОШИБКА запуска AR");
    alert("AR не запустился — смотри статус сверху");
  }
};
</script>

</body>
</html>
