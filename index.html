<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Видео с кнопкой разместить</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; }
  #fileInput {
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    z-index:10; background: rgba(0,0,0,0.5); color:white; padding:5px 10px; border-radius:5px;
  }
  #placeBtn {
    position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
    z-index:10; background: rgba(0,0,0,0.5); color:white; padding:10px 20px; border-radius:5px;
    font-size:16px; cursor:pointer;
  }
  #videoTime {
    position: fixed;
    top: 10px;
    right: 10px;
    color: white;
    background: rgba(0,0,0,0.6);
    padding: 5px 10px;
    border-radius: 5px;
    font-family: monospace;
    z-index: 10;
  }
</style>
</head>
<body>

<input type="file" id="fileInput" accept="video/*">
<div id="videoTime">00:00 / 00:00</div>
<div id="placeBtn">Разместить видео</div>

<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
  <a-entity camera look-controls>
    <a-cursor 
      fuse="true" 
      fuse-timeout="2000" 
      raycaster="objects: .clickable"
      geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.02"
      material="color:white; shader:flat">
    </a-cursor>
  </a-entity>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
const placeBtn = document.getElementById('placeBtn');
const timeEl = document.getElementById('videoTime');

let videoEl, videoMesh, videoTexture;
let videoWidth = 1, videoHeight = 0.6;
let firstInteraction = true;

// Загрузка видео
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);

  videoEl = document.createElement('video');
  videoEl.src = url;
  videoEl.loop = true;
  videoEl.muted = true;
  videoEl.playsInline = true;
  videoEl.crossOrigin = 'anonymous';

  videoEl.addEventListener('loadeddata', () => {
    videoWidth = videoEl.videoWidth / videoEl.videoHeight;
    videoHeight = 1;
    videoTexture = new THREE.VideoTexture(videoEl);
  });
});

// Таймер видео
setInterval(() => {
  if(!videoEl || !videoEl.duration) return;
  const f = t => `${Math.floor(t/60).toString().padStart(2,'0')}:${Math.floor(t%60).toString().padStart(2,'0')}`;
  timeEl.textContent = `${f(videoEl.currentTime)} / ${f(videoEl.duration)}`;
}, 300);

// Размещение видео по кнопке
placeBtn.addEventListener('click', () => {
  if(!videoEl) return;

  // Позиция перед камерой
  const camera = scene.camera;
  const distance = 2;
  const pos = camera.position.clone().add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(distance));

  // Создаем Mesh, если еще нет
  if(!videoMesh){
    const geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
    const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
    videoMesh = new THREE.Mesh(geometry, material);
    scene.object3D.add(videoMesh);
  }

  videoMesh.position.copy(pos);
  videoMesh.rotation.copy(camera.rotation);
  videoMesh.rotateX(Math.PI/2);
  videoMesh.visible = true;

  if(firstInteraction){
    videoEl.muted = false;
    videoEl.play().catch(()=>{});
    firstInteraction = false;
  }

  createButtons(pos);
});

// Масштабирование пальцами
let startDistance = null;
let startScale = 1;
scene.addEventListener('touchstart', e => {
  if(e.touches.length==2 && videoMesh){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    startDistance = Math.sqrt(dx*dx + dy*dy);
    startScale = videoMesh.scale.x;
  }
});
scene.addEventListener('touchmove', e => {
  if(e.touches.length==2 && videoMesh && startDistance){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const scaleFactor = Math.sqrt(dx*dx+dy*dy)/startDistance;
    videoMesh.scale.set(startScale*scaleFactor, startScale*scaleFactor,1);
  }
});

// Создание кнопок под видео
function createButtons(pos){
  if(document.getElementById('playBtn')) return; // уже есть

  const btnY = pos.y - videoHeight/2 - 0.2;

  const playBtn = document.createElement('a-plane');
  playBtn.setAttribute('id','playBtn');
  playBtn.setAttribute('class','clickable');
  playBtn.setAttribute('color','#00ff00');
  playBtn.setAttribute('width','0.4');
  playBtn.setAttribute('height','0.15');
  playBtn.setAttribute('position', `${pos.x-0.25} ${btnY} ${pos.z}`);
  playBtn.setAttribute('text','value:Play;align:center');
  scene.appendChild(playBtn);

  const pauseBtn = document.createElement('a-plane');
  pauseBtn.setAttribute('id','pauseBtn');
  pauseBtn.setAttribute('class','clickable');
  pauseBtn.setAttribute('color','#ff0000');
  pauseBtn.setAttribute('width','0.4');
  pauseBtn.setAttribute('height','0.15');
  pauseBtn.setAttribute('position', `${pos.x+0.25} ${btnY} ${pos.z}`);
  pauseBtn.setAttribute('text','value:Pause;align:center');
  scene.appendChild(pauseBtn);

  addFuse(playBtn, () => videoEl.play());
  addFuse(pauseBtn, () => videoEl.pause());
}

// Fuse 2 секунды
function addFuse(el, callback){
  let timer = null;
  el.addEventListener('mouseenter', () => { timer = setTimeout(callback,2000); });
  el.addEventListener('mouseleave', () => { if(timer) clearTimeout(timer); });
}
</script>
</body>
</html>
