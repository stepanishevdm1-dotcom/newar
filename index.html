<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR –í–∏–¥–µ–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin:0; overflow:hidden; }
    #fileInput {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      z-index:100; background: rgba(0,0,0,0.5); color:white; padding:5px 10px; border-radius:5px;
    }
    .video-controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 15px; z-index:100;
    }
    .control-btn {
      padding: 10px 15px; border-radius: 5px;
      background: rgba(0,0,0,0.5); color: white; cursor: pointer;
    }
  </style>
</head>
<body>
<input type="file" id="fileInput" accept="video/*">
<div class="video-controls">
  <div class="control-btn" id="playBtn">‚ñ∂ Play</div>
  <div class="control-btn" id="pauseBtn">‚è∏ Pause</div>
  <div class="control-btn" id="hideBtn">‚úñ Hide</div>
  <div class="control-btn" id="showBtn">üì∫ Show</div>
</div>

<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');

const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const hideBtn = document.getElementById('hideBtn');
const showBtn = document.getElementById('showBtn');

let videoEl, videoMesh, videoTexture;
let videoWidth = 1, videoHeight = 0.6;
let firstInteraction = true;

// --------------------- –í–∏–¥–µ–æ ---------------------
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);

  videoEl = document.createElement('video');
  videoEl.src = url;
  videoEl.loop = true;
  videoEl.muted = false;
  videoEl.playsInline = true;
  videoEl.crossOrigin = 'anonymous';

  videoEl.addEventListener('loadeddata', () => {
    videoWidth = videoEl.videoWidth / videoEl.videoHeight;
    videoHeight = 1;

    if(!videoMesh){
      const geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
      videoTexture = new THREE.VideoTexture(videoEl);
      const material = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });
      videoMesh = new THREE.Mesh(geometry, material);
      videoMesh.visible = false;
      scene.object3D.add(videoMesh);
    } else {
      videoMesh.geometry.dispose();
      videoMesh.geometry = new THREE.PlaneGeometry(videoWidth, videoHeight);
    }
  });
});

// --------------------- –ö–Ω–æ–ø–∫–∏ ---------------------
playBtn.addEventListener('click', () => { if(videoEl) videoEl.play(); });
pauseBtn.addEventListener('click', () => { if(videoEl) videoEl.pause(); });
hideBtn.addEventListener('click', () => { if(videoMesh) videoMesh.visible = false; });

// --------------------- –ü–æ–∫–∞–∑ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π ---------------------
showBtn.addEventListener('click', () => {
  if(!videoMesh || !videoEl) return;

  const camera = scene.camera;
  const distance = 2; // 2 –º–µ—Ç—Ä–∞ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π
  const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
  const pos = camera.position.clone().add(dir.multiplyScalar(distance));

  videoMesh.position.copy(pos);
  videoMesh.visible = true;

  if(firstInteraction){
    videoEl.muted = false;
    videoEl.play().catch(()=>{});
    firstInteraction = false;
  }
});

// --------------------- Billboard ---------------------
scene.addEventListener('render-target-loaded', () => {
  scene.addEventListener('tick', () => {
    if(videoMesh && videoMesh.visible){
      videoMesh.lookAt(scene.camera.position);
    }
  });
});
</script>
</body>
</html>
